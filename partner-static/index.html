<html>
  <body>
    <h1>Partner site</h1>
    <script>
      function getToken(url) {
        return new Promise((resolve, reject) => {
          var iframe = document.createElement('iframe');
          var retry = 0;
          var tokenReady = false;
          iframe.src = url;
          iframe.width = 0;
          iframe.height = 0;
          iframe.style.opacity = 0;
          document.body.appendChild(iframe);
          iframe.onload = () => {
            function _getToken() {
              if (tokenReady) return;
              iframe.contentWindow.postMessage('getToken', 'https://payments.summerisgone.com');
              retry++;
              if (retry < 3) {
                setTimeout(_getToken, 500);
              } else {
                console.error('unauthorised');
                reject('unauthorised');
              }
            }
            _getToken();
          }
  
          function receiveMessage(event)
          {
            if (event.data.startsWith && event.data.startsWith('token')) {
              console.log('token is', event.data);
              resolve(event.data);
              tokenReady = true;
            }
          }
        
          window.addEventListener('message', receiveMessage, false);
        });
      }

      function openAuth(resolve, reject) {
        var authWindow = window.open("https://payments.summerisgone.com/accounts/login/", "hello", "width=200,height=200,left=500,top=300");
        function receiveMessage(event) {
          if ((event.origin === 'https://payments.summerisgone.com') &&
            (event.data === 'close')) {
              authWindow.close();
              resolve();
            }
        }
        window.addEventListener('message', receiveMessage, false);
        // close popup after 10s
        setTimeout(() => {
          reject('unauthorized')
        }, 10000);
      }

      getToken('https://payments.summerisgone.com/token')
      .then(token => console.log('token:', token))
      .catch(error => {
        return new Promise((resolve, reject) => {
          var button = document.createElement('button');
          button.textContent = 'log in';
          button.onclick = () => {
            openAuth(resolve, reject)
          };
          document.body.appendChild(button);
        });
      })
      .then(() => (getToken('https://payments.summerisgone.com/token')))
      .then(token => {
        return fetch('https://payments.summerisgone.com/api/tx', {
          method: 'POST',
          mode: 'cors',
          credentials: 'include',
          headers: new Headers({
            'Authorization': `Token ${token.split(':')[1]}`,
            'Content-Type': 'application/json'
          }),
          body: JSON.stringify({user_to: 'user1', amount: 1})
        })
        .then(() => (token));
      })
      .then(token => {
        return fetch('https://payments.summerisgone.com/api/wallet', {
          method: 'GET',
          mode: 'cors',
          credentials: 'include',
          headers: new Headers({
            'Authorization': `Token ${token.split(':')[1]}`
          })
        }).then(response => (response.json())).then(data => {
          console.log('balance: ', data[0].balance);
        });
      })
        
    </script>
  </body>
</html>
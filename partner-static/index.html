<html>
  <body>
    <h1>Partner site</h1>
    <script>
      function getToken(origin) {
        return new Promise((resolve, reject) => {
          var iframe = document.createElement('iframe');
          var retry = 0;
          var tokenReady = false;
          iframe.src = origin;
          iframe.width = 0;
          iframe.height = 0;
          iframe.style.opacity = 0;
          document.body.appendChild(iframe);
          iframe.onload = () => {
            function _getToken() {
              if (tokenReady) return;
              iframe.contentWindow.postMessage('getToken', 'http://localhost:8000');
              retry++;
              if (retry < 3) {
                setTimeout(_getToken, 500);
              } else {
                console.error('unauthorised');
                reject('unauthorised');
              }
            }
            _getToken();
          }
  
          function receiveMessage(event)
          {
            if (event.data.startsWith && event.data.startsWith('token')) {
              console.log('token is', event.data);
              resolve(event.data);
              tokenReady = true;
            }
          }
        
          window.addEventListener('message', receiveMessage, false);
        });
      }

      function openAuth(resolve, reject) {
        var authWindow = window.open("http://localhost:8000/accounts/login/", "hello", "width=200,height=200,left=500,top=300");
        function receiveMessage(event) {
          if ((event.origin === 'http://localhost:8000') &&
            (event.data === 'close')) {
              authWindow.close();
              resolve();
            }
        }
        window.addEventListener('message', receiveMessage, false);
        // close popup after 10s
        setTimeout(() => {
          reject('unauthorized')
        }, 10000);
      }

      getToken('http://localhost:8000/token')
      .then(token => console.log('token:', token))
      .catch(error => {
        return new Promise((resolve, reject) => {
          var button = document.createElement('button');
          button.textContent = 'log in';
          button.onclick = () => {
            openAuth(resolve, reject)
          };
          document.body.appendChild(button);
        });
      })
      .then(() => {
        getToken('http://localhost:8000/token')
      })
        
    </script>
  </body>
</html>